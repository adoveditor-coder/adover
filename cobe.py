import discord
from discord.ext import commands
from discord import app_commands
import random
import asyncio
import os
from datetime import datetime, timedelta
import aiosqlite
import re

# ุฅุนุฏุงุฏุงุช ุงูุจูุช ุงูุฃุณุงุณูุฉ ูุน ุชุญุณูู ุงูุฃุฏุงุก [citation:1]
intents = discord.Intents.default()
intents.members = True
intents.message_content = True

bot = commands.Bot(
    command_prefix='!', 
    intents=intents,
    # ุชุญุณูู ุฃุฏุงุก ุงูุจูุช [citation:1]
    max_messages=None,  # ุชูููู ุงุณุชุฎุฏุงู ุงูุฐุงูุฑุฉ
    chunk_guilds_at_startup=False  # ุชุญุณูู ููุช ุงูุจุฏุก
)

# ูุงุนุฏุฉ ุงูุจูุงูุงุช ูุน ุชุญุณูู ุงูุฃุฏุงุก [citation:1]
DB_NAME = "bot_database.db"

# ุชุฑุฌูุฉ ุงููุตูุต ููุบุชูู ูุน ุชุญุณูู ุงุณุชุฎุฏุงู ุงูุฐุงูุฑุฉ [citation:1]
translations = {
    "ar": {
        "ban_success": "ุชู ุญุธุฑ {} ุจุณุจุจ: {}",
        "ban_no_permission": "ููุณ ูุฏูู ุตูุงุญูุฉ ูุญุธุฑ ุงูุฃุนุถุงุก!",
        "unban_success": "ุชู ุฑูุน ุงูุญุธุฑ ุนู {}",
        "unban_no_permission": "ููุณ ูุฏูู ุตูุงุญูุฉ ูุฑูุน ุงูุญุธุฑ ุนู ุงูุฃุนุถุงุก!",
        "unban_not_found": "ูู ูุชู ุงูุนุซูุฑ ุนูู ูุฐุง ุงููุณุชุฎุฏู ุฃู ุงูุขูุฏู ุบูุฑ ุตุญูุญ!",
        "kick_success": "ุชู ุทุฑุฏ {} ุจุณุจุจ: {}",
        "kick_no_permission": "ููุณ ูุฏูู ุตูุงุญูุฉ ูุทุฑุฏ ุงูุฃุนุถุงุก!",
        "mute_success": "ุชู ูุชู {} ููุฏุฉ {} ุฏูุงุฆู ุจุณุจุจ: {}",
        "mute_no_permission": "ููุณ ูุฏูู ุตูุงุญูุฉ ููุชู ุงูุฃุนุถุงุก!",
        "unmute_success": "ุชู ุฑูุน ุงููุชู ุนู {}",
        "unmute_no_permission": "ููุณ ูุฏูู ุตูุงุญูุฉ ูุฑูุน ุงููุชู ุนู ุงูุฃุนุถุงุก!",
        "unmute_not_muted": "ูุฐุง ุงูุนุถู ุบูุฑ ููุชูู!",
        "warn_success": "ุชู ุชุญุฐูุฑ {}. ุนุฏุฏ ุชุญุฐูุฑุงุชู: {}. ุงูุณุจุจ: {}",
        "warn_no_permission": "ููุณ ูุฏูู ุตูุงุญูุฉ ูุชุญุฐูุฑ ุงูุฃุนุถุงุก!",
        "clear_success": "ุชู ูุณุญ {} ุฑุณุงูุฉ!",
        "clear_no_permission": "ููุณ ูุฏูู ุตูุงุญูุฉ ููุณุญ ุงูุฑุณุงุฆู!",
        "clear_too_many": "ูุง ูููู ูุณุญ ุฃูุซุฑ ูู 100 ุฑุณุงูุฉ ูู ุงููุฑุฉ ุงููุงุญุฏุฉ!",
        "nick_success": "ุชู ุชุบููุฑ ููุจ {} ุฅูู {}",
        "nick_no_permission": "ููุณ ูุฏูู ุตูุงุญูุฉ ูุชุบููุฑ ุงูุฃููุงุจ!",
        "role_add_success": "ุชู ุฅุถุงูุฉ ุฏูุฑ {} ุฅูู {}",
        "role_remove_success": "ุชู ุฅุฒุงูุฉ ุฏูุฑ {} ูู {}",
        "role_no_permission": "ููุณ ูุฏูู ุตูุงุญูุฉ ูุฅุฏุงุฑุฉ ุงูุฃุฏูุงุฑ!",
        "role_invalid_action": "ุงูุฅุฌุฑุงุก ูุฌุจ ุฃู ูููู ุฅูุง add ุฃู remove!",
        "language_set": "ุชู ุชุนููู ุงููุบุฉ ุฅูู ุงูุนุฑุจูุฉ ุจูุฌุงุญ!",
        "language_already_set": "ุงููุบุฉ ูุถุจูุทุฉ ุจุงููุนู ุนูู ุงูุนุฑุจูุฉ!",
        "language_changed": "ุชู ุชุบููุฑ ุงููุบุฉ ุฅูู ุงูุนุฑุจูุฉ ุจูุฌุงุญ!",
        "language_set_english": "Language has been set to English successfully!",
        "language_already_set_english": "Language is already set to English!",
        "language_changed_english": "Language has been changed to English successfully!",
        "select_language": "ูุฑุฌู ุงุฎุชูุงุฑ ุงููุบุฉ / Please select a language",
        "arabic": "ุงูุนุฑุจูุฉ",
        "english": "English",
        "points_display": "{} ูุฏูู {} ููุทุฉ!",
        "rep_success": "ุชู ููุญ ููุทุฉ ุณูุนุฉ ูู {}!",
        "rep_self": "ูุง ููููู ููุญ ุงูุณูุนุฉ ูููุณู!",
        "server_info_title": "ูุนูููุงุช ุงูุณูุฑูุฑ: {}",
        "user_info_title": "ูุนูููุงุช ุงููุณุชุฎุฏู: {}",
        "top_members_title": "ุฃูุถู 10 ุฃุนุถุงุก ุญุณุจ ุงูููุงุท",
        "profile_title": "ุงูููู ุงูุดุฎุตู ูู {}",
        "roll_result": "๐ฒ {} ุฑูู ุงููุฑุฏ ูุญุตู ุนูู: {} (ูู ุฃุตู {})",
        "8ball_response": "๐ฑ ุงูุณุคุงู: {}\nุงูุฅุฌุงุจุฉ: {}",
        "coinflip_result": "๐ช {} ุฑูู ุงูุนููุฉ ูุญุตู ุนูู: {}",
        "meme_title": "ููู ุนุดูุงุฆู",
        "ping_result": "๐ ุณุฑุนุฉ ุงูุงุณุชุฌุงุจุฉ: {}ms",
        "welcome_message": "ูุฑุญุจุงู ุจู ูู ุงูุณูุฑูุฑ! ูุฑุฌู ุงุณุชุฎุฏุงู ุงูุฃูุฑ `/language` ูุงุฎุชูุงุฑ ุงููุบุฉ.",
        "channel_restrict_success": "ุชู ุชูููุฏ ุงูุจูุช ููููุงุฉ {} ุจูุฌุงุญ!",
        "channel_restrict_remove": "ุชู ุฅูุบุงุก ุชูููุฏ ุงูุจูุช ููููุงุฉ {} ุจูุฌุงุญ!",
        "channel_restrict_list": "ุงููููุงุช ุงููุณููุญ ููุจูุช ุจุงูุนูู ูููุง: {}",
        "channel_restrict_none": "ูุง ุชูุฌุฏ ูููุฏ ุนูู ุงููููุงุชุ ุงูุจูุช ูุนูู ูู ุฌููุน ุงููููุงุช.",
        "channel_not_allowed": "ูุฐุง ุงูุจูุช ุบูุฑ ูุณููุญ ูู ุจุงูุนูู ูู ูุฐู ุงูููุงุฉ!",
        "slowmode_success": "ุชู ุชุนููู ุงููุถุน ุงูุจุทูุก ุฅูู {} ุซูุงูู ููุฐู ุงูููุงุฉ!",
        "slowmode_remove": "ุชู ุฅูุบุงุก ุงููุถุน ุงูุจุทูุก ููุฐู ุงูููุงุฉ!",
        "poll_created": "ุชู ุฅูุดุงุก ุงูุงุณุชูุชุงุก ุจูุฌุงุญ!",
        "poll_question": "ุณุคุงู ุงูุงุณุชูุชุงุก",
        "suggest_added": "ุชู ุฅุถุงูุฉ ุงูุงูุชุฑุงุญ ุจูุฌุงุญ!",
        "tag_created": "ุชู ุฅูุดุงุก ุงููุณู '{}' ุจูุฌุงุญ!",
        "tag_exists": "ูุฐุง ุงููุณู ููุฌูุฏ ุจุงููุนู!",
        "tag_not_found": "ุงููุณู '{}' ุบูุฑ ููุฌูุฏ!",
        "tag_deleted": "ุชู ุญุฐู ุงููุณู '{}' ุจูุฌุงุญ!",
        "tag_info": "ูุนูููุงุช ุงููุณู '{}': {}",
        "invite_bot": "https://discord.com/oauth2/authorize?client_id={}&scope=bot&permissions=8",
        "trigger_added": "ุชู ุฅุถุงูุฉ ุงูุงุฎุชุตุงุฑ '{}' ุจูุฌุงุญ ููุฑุชุจ: {}!",
        "trigger_removed": "ุชู ุฅุฒุงูุฉ ุงูุงุฎุชุตุงุฑ '{}' ุจูุฌุงุญ!",
        "trigger_exists": "ุงูุงุฎุชุตุงุฑ '{}' ููุฌูุฏ ุจุงููุนู!",
        "trigger_not_found": "ุงูุงุฎุชุตุงุฑ '{}' ุบูุฑ ููุฌูุฏ!",
        "trigger_list": "ูุงุฆูุฉ ุงูุงุฎุชุตุงุฑุงุช:\n{}",
        "trigger_no_permission": "ููุณ ูุฏูู ุตูุงุญูุฉ ูุฅุฏุงุฑุฉ ุงูุงุฎุชุตุงุฑุงุช!",
        "help_command": """
**๐ฏ ุงูุฃูุงูุฑ ุงูุฅุฏุงุฑูุฉ:**
`/ban` - ุญุธุฑ ุนุถู ูู ุงูุณูุฑูุฑ
`/unban` - ุฑูุน ุงูุญุธุฑ ุนู ุนุถู
`/kick` - ุทุฑุฏ ุนุถู ูู ุงูุณูุฑูุฑ
`/mute` - ูุชู ุนุถู
`/unmute` - ุฑูุน ุงููุชู ุนู ุนุถู
`/warn` - ุชุญุฐูุฑ ุนุถู
`/clear` - ูุณุญ ุงูุฑุณุงุฆู
`/setnick` - ุชุบููุฑ ููุจ ุนุถู
`/role` - ุฅุฏุงุฑุฉ ุฃุฏูุงุฑ ุงูุนุถู
`/slowmode` - ุชุนููู ูุถุน ุจุทูุก
`/serverinfo` - ูุนูููุงุช ุงูุณูุฑูุฑ
`/userinfo` - ูุนูููุงุช ุงููุณุชุฎุฏู

**๐ช ุงูุฃูุงูุฑ ุงูุชุฑููููุฉ:**
`/roll` - ุฑูู ูุฑุฏ ุนุดูุงุฆู
`/8ball` - ุณุคุงู ุงููุฑุฉ ุงูุณุญุฑูุฉ
`/coinflip` - ุฑูู ุนููุฉ ูุนุฏููุฉ
`/meme` - ุนุฑุถ ููู ุนุดูุงุฆู
`/ping` - ุงุฎุชุจุงุฑ ุณุฑุนุฉ ุงูุงุณุชุฌุงุจุฉ

**โ๏ธ ุฃูุงูุฑ ุงูุฅุนุฏุงุฏุงุช:**
`/language` - ุชุบููุฑ ูุบุฉ ุงูุจูุช
`/channel_restrict` - ุชูููุฏ ุงูุจูุช ููููุงุฉ
`/channel_unrestrict` - ุฅูุบุงุก ุชูููุฏ ุงูููุงุฉ
`/channel_list` - ุนุฑุถ ุงููููุงุช ุงููุณููุญุฉ

**๐ท๏ธ ุฃูุงูุฑ ุงูุฃูุณูุฉ:**
`/tag_create` - ุฅูุดุงุก ูุณู ุฌุฏูุฏ
`/tag` - ุนุฑุถ ูุณู
`/tag_delete` - ุญุฐู ูุณู
`/tag_list` - ุนุฑุถ ุฌููุน ุงูุฃูุณูุฉ

**๐ ุฃูุงูุฑ ุงูููุงุท:**
`/credits` - ุนุฑุถ ุงูุฑุตูุฏ
`/rep` - ููุญ ุณูุนุฉ
`/rank` - ุนุฑุถ ุงูุฑุชุจุฉ
`/top` - ุฃูุถู ุงูุฃุนุถุงุก
`/profile` - ุงูููู ุงูุดุฎุตู

**๐ง ุฃูุงูุฑ ุงูุงุฎุชุตุงุฑุงุช (ุจุงุณุชุฎุฏุงู !):**
`!addtrigger` - ุฅุถุงูุฉ ุงุฎุชุตุงุฑ ุฌุฏูุฏ
`!deltrigger` - ุญุฐู ุงุฎุชุตุงุฑ
`!listtriggers` - ุนุฑุถ ุฌููุน ุงูุงุฎุชุตุงุฑุงุช
"""
    },
    "en": {
        "ban_success": "Banned {} for: {}",
        "ban_no_permission": "You don't have permission to ban members!",
        "unban_success": "Unbanned {}",
        "unban_no_permission": "You don't have permission to unban members!",
        "unban_not_found": "User not found or ID is incorrect!",
        "kick_success": "Kicked {} for: {}",
        "kick_no_permission": "You don't have permission to kick members!",
        "mute_success": "Muted {} for {} minutes because: {}",
        "mute_no_permission": "You don't have permission to mute members!",
        "unmute_success": "Unmuted {}",
        "unmute_no_permission": "You don't have permission to unmute members!",
        "unmute_not_muted": "This member is not muted!",
        "warn_success": "Warned {}. Warning count: {}. Reason: {}",
        "warn_no_permission": "You don't have permission to warn members!",
        "clear_success": "Cleared {} messages!",
        "clear_no_permission": "You don't have permission to clear messages!",
        "clear_too_many": "Cannot delete more than 100 messages at once!",
        "nick_success": "Changed {}'s nickname to {}",
        "nick_no_permission": "You don't have permission to change nicknames!",
        "role_add_success": "Added role {} to {}",
        "role_remove_success": "Removed role {} from {}",
        "role_no_permission": "You don't have permission to manage roles!",
        "role_invalid_action": "Action must be either add or remove!",
        "language_set": "ุชู ุชุนููู ุงููุบุฉ ุฅูู ุงูุนุฑุจูุฉ ุจูุฌุงุญ!",
        "language_already_set": "ุงููุบุฉ ูุถุจูุทุฉ ุจุงููุนู ุนูู ุงูุนุฑุจูุฉ!",
        "language_changed": "ุชู ุชุบููุฑ ุงููุบุฉ ุฅูู ุงูุนุฑุจูุฉ ุจูุฌุงุญ!",
        "language_set_english": "Language has been set to English successfully!",
        "language_already_set_english": "Language is already set to English!",
        "language_changed_english": "Language has been changed to English successfully!",
        "select_language": "ูุฑุฌู ุงุฎุชูุงุฑ ุงููุบุฉ / Please select a language",
        "arabic": "ุงูุนุฑุจูุฉ",
        "english": "English",
        "points_display": "{} has {} points!",
        "rep_success": "Gave a reputation point to {}!",
        "rep_self": "You cannot give reputation to yourself!",
        "server_info_title": "Server Info: {}",
        "user_info_title": "User Info: {}",
        "top_members_title": "Top 10 Members by Points",
        "profile_title": "{}'s Profile",
        "roll_result": "๐ฒ {} rolled the dice and got: {} (out of {})",
        "8ball_response": "๐ฑ Question: {}\nAnswer: {}",
        "coinflip_result": "๐ช {} flipped a coin and got: {}",
        "meme_title": "Random Meme",
        "ping_result": "๐ Ping: {}ms",
        "welcome_message": "Welcome to the server! Please use the `/language` command to choose a language.",
        "channel_restrict_success": "Bot restricted to channel {} successfully!",
        "channel_restrict_remove": "Bot restriction removed from channel {} successfully!",
        "channel_restrict_list": "Channels where bot is allowed: {}",
        "channel_restrict_none": "No channel restrictions, bot works in all channels.",
        "channel_not_allowed": "This bot is not allowed to work in this channel!",
        "slowmode_success": "Set slowmode to {} seconds for this channel!",
        "slowmode_remove": "Slowmode disabled for this channel!",
        "poll_created": "Poll created successfully!",
        "poll_question": "Poll question",
        "suggest_added": "Suggestion added successfully!",
        "tag_created": "Tag '{}' created successfully!",
        "tag_exists": "This tag already exists!",
        "tag_not_found": "Tag '{}' not found!",
        "tag_deleted": "Tag '{}' deleted successfully!",
        "tag_info": "Tag '{}' info: {}",
        "invite_bot": "https://discord.com/oauth2/authorize?client_id={}&scope=bot&permissions=8",
        "trigger_added": "Trigger '{}' added successfully for roles: {}!",
        "trigger_removed": "Trigger '{}' removed successfully!",
        "trigger_exists": "Trigger '{}' already exists!",
        "trigger_not_found": "Trigger '{}' not found!",
        "trigger_list": "Trigger list:\n{}",
        "trigger_no_permission": "You don't have permission to manage triggers!",
        "help_command": """
**๐ฏ Administrative Commands:**
`/ban` - Ban a member
`/unban` - Unban a member
`/kick` - Kick a member
`/mute` - Mute a member
`/unmute` - Unmute a member
`/warn` - Warn a member
`/clear` - Clear messages
`/setnick` - Change member nickname
`/role` - Manage member roles
`/slowmode` - Set slowmode
`/serverinfo` - Server information
`/userinfo` - User information

**๐ช Entertainment Commands:**
`/roll` - Roll a dice
`/8ball` - Ask the magic ball
`/coinflip` - Flip a coin
`/meme` - Show random meme
`/ping` - Test response speed

**โ๏ธ Settings Commands:**
`/language` - Change bot language
`/channel_restrict` - Restrict bot to channel
`/channel_unrestrict` - Remove channel restriction
`/channel_list` - Show allowed channels

**๐ท๏ธ Tag Commands:**
`/tag_create` - Create a new tag
`/tag` - Show a tag
`/tag_delete` - Delete a tag
`/tag_list` - Show all tags

**๐ Points Commands:**
`/credits` - Show credits
`/rep` - Give reputation
`/rank` - Show rank
`/top` - Top members
`/profile` - Profile

**๐ง Trigger Commands (using !):**
`!addtrigger` - Add a new trigger
`!deltrigger` - Delete a trigger
`!listtriggers` - List all triggers
"""
    }
}

# ุฃูุธูุฉ ุฏุงุฎููุฉ ูุน ุชุญุณูู ุงูุฃุฏุงุก [citation:1]
class DatabaseSystem:
    def __init__(self, db_name):
        self.db_name = db_name
        # ุชุญุณูู ุงุณุชุฎุฏุงู ุงูุฐุงูุฑุฉ [citation:1]
        self._connection_pool = None
        
    async def _get_connection(self):
        if self._connection_pool is None:
            self._connection_pool = await aiosqlite.connect(
                self.db_name,
                check_same_thread=False,
                cached_statements=100  # ุชุญุณูู ุฃุฏุงุก ุงูุงุณุชุนูุงูุงุช [citation:1]
            )
        return self._connection_pool
        
    async def init_db(self):
        conn = await self._get_connection()
        
        # ุฌุฏูู ุฅุนุฏุงุฏุงุช ุงูุณูุฑูุฑ
        await conn.execute('''
            CREATE TABLE IF NOT EXISTS guild_settings (
                guild_id INTEGER PRIMARY KEY,
                language TEXT DEFAULT 'ar',
                welcome_channel_id INTEGER DEFAULT NULL,
                log_channel_id INTEGER DEFAULT NULL
            )
        ''')
        
        # ุฌุฏูู ุงููุณุชุฎุฏููู
        await conn.execute('''
            CREATE TABLE IF NOT EXISTS users (
                user_id INTEGER PRIMARY KEY,
                points INTEGER DEFAULT 0,
                reputation INTEGER DEFAULT 0,
                level INTEGER DEFAULT 1,
                warnings INTEGER DEFAULT 0
            )
        ''')
        
        # ุฌุฏูู ุงููููุงุช ุงููุณููุญุฉ
        await conn.execute('''
            CREATE TABLE IF NOT EXISTS allowed_channels (
                guild_id INTEGER,
                channel_id INTEGER,
                PRIMARY KEY (guild_id, channel_id)
            )
        ''')
        
        # ุฌุฏูู ุงูุฃูุณูุฉ
        await conn.execute('''
            CREATE TABLE IF NOT EXISTS tags (
                guild_id INTEGER,
                name TEXT,
                content TEXT,
                PRIMARY KEY (guild_id, name)
            )
        ''')
        
        # ุฌุฏูู ุงูุงุฎุชุตุงุฑุงุช (Triggers)
        await conn.execute('''
            CREATE TABLE IF NOT EXISTS triggers (
                guild_id INTEGER,
                trigger_word TEXT,
                response TEXT,
                PRIMARY KEY (guild_id, trigger_word)
            )
        ''')
        
        # ุฌุฏูู ุฑุชุจ ุงูุงุฎุชุตุงุฑุงุช
        await conn.execute('''
            CREATE TABLE IF NOT EXISTS trigger_roles (
                guild_id INTEGER,
                trigger_word TEXT,
                role_id INTEGER,
                PRIMARY KEY (guild_id, trigger_word, role_id)
            )
        ''')
        
        await conn.commit()
    
    async def get_guild_language(self, guild_id):
        conn = await self._get_connection()
        cursor = await conn.execute('SELECT language FROM guild_settings WHERE guild_id = ?', (guild_id,))
        data = await cursor.fetchone()
        if data:
            return data[0]
        else:
            # ุฅูุดุงุก ุฅุนุฏุงุฏุงุช ุฌุฏูุฏุฉ ููุณูุฑูุฑ ุฅุฐุง ูู ุชูุฌุฏ
            await conn.execute('INSERT INTO guild_settings (guild_id, language) VALUES (?, ?)', (guild_id, 'ar'))
            await conn.commit()
            return 'ar'
    
    async def set_guild_language(self, guild_id, language):
        conn = await self._get_connection()
        await conn.execute('UPDATE guild_settings SET language = ? WHERE guild_id = ?', (language, guild_id))
        await conn.commit()
    
    async def get_user_data(self, user_id):
        conn = await self._get_connection()
        cursor = await conn.execute('SELECT * FROM users WHERE user_id = ?', (user_id,))
        data = await cursor.fetchone()
        if data:
            return {
                'user_id': data[0],
                'points': data[1],
                'reputation': data[2],
                'level': data[3],
                'warnings': data[4]
            }
        else:
            # ุฅูุดุงุก ูุณุชุฎุฏู ุฌุฏูุฏ ุฅุฐุง ูู ููุฌุฏ
            await conn.execute('INSERT INTO users (user_id) VALUES (?)', (user_id,))
            await conn.commit()
            return {
                'user_id': user_id,
                'points': 0,
                'reputation': 0,
                'level': 1,
                'warnings': 0
            }
    
    async def add_points(self, user_id, amount):
        conn = await self._get_connection()
        await conn.execute('UPDATE users SET points = points + ? WHERE user_id = ?', (amount, user_id))
        await conn.commit()
    
    async def add_reputation(self, user_id, amount):
        conn = await self._get_connection()
        await conn.execute('UPDATE users SET reputation = reputation + ? WHERE user_id = ?', (amount, user_id))
        await conn.commit()
    
    async def get_allowed_channels(self, guild_id):
        conn = await self._get_connection()
        cursor = await conn.execute('SELECT channel_id FROM allowed_channels WHERE guild_id = ?', (guild_id,))
        channels = await cursor.fetchall()
        return [channel[0] for channel in channels]
    
    async def add_allowed_channel(self, guild_id, channel_id):
        conn = await self._get_connection()
        await conn.execute('INSERT OR IGNORE INTO allowed_channels (guild_id, channel_id) VALUES (?, ?)', (guild_id, channel_id))
        await conn.commit()
    
    async def remove_allowed_channel(self, guild_id, channel_id):
        conn = await self._get_connection()
        await conn.execute('DELETE FROM allowed_channels WHERE guild_id = ? AND channel_id = ?', (guild_id, channel_id))
        await conn.commit()
    
    async def get_tag(self, guild_id, name):
        conn = await self._get_connection()
        cursor = await conn.execute('SELECT content FROM tags WHERE guild_id = ? AND name = ?', (guild_id, name))
        data = await cursor.fetchone()
        return data[0] if data else None
    
    async def set_tag(self, guild_id, name, content):
        conn = await self._get_connection()
        await conn.execute('INSERT OR REPLACE INTO tags (guild_id, name, content) VALUES (?, ?, ?)', (guild_id, name, content))
        await conn.commit()
    
    async def delete_tag(self, guild_id, name):
        conn = await self._get_connection()
        await conn.execute('DELETE FROM tags WHERE guild_id = ? AND name = ?', (guild_id, name))
        await conn.commit()
    
    async def get_all_tags(self, guild_id):
        conn = await self._get_connection()
        cursor = await conn.execute('SELECT name FROM tags WHERE guild_id = ?', (guild_id,))
        tags = await cursor.fetchall()
        return [tag[0] for tag in tags]
    
    # ุฏูุงู ูุธุงู ุงูุงุฎุชุตุงุฑุงุช
    async def add_trigger(self, guild_id, trigger_word, response, role_ids):
        conn = await self._get_connection()
        # ุฅุถุงูุฉ ุงูุงุฎุชุตุงุฑ
        await conn.execute('INSERT INTO triggers (guild_id, trigger_word, response) VALUES (?, ?, ?)', 
                        (guild_id, trigger_word, response))
        
        # ุฅุถุงูุฉ ุงูุฑุชุจ ุงููุณููุญุฉ
        for role_id in role_ids:
            await conn.execute('INSERT INTO trigger_roles (guild_id, trigger_word, role_id) VALUES (?, ?, ?)', 
                            (guild_id, trigger_word, role_id))
        
        await conn.commit()
    
    async def remove_trigger(self, guild_id, trigger_word):
        conn = await self._get_connection()
        # ุญุฐู ุงูุงุฎุชุตุงุฑ
        await conn.execute('DELETE FROM triggers WHERE guild_id = ? AND trigger_word = ?', 
                        (guild_id, trigger_word))
        
        # ุญุฐู ุงูุฑุชุจ ุงููุฑุชุจุทุฉ
        await conn.execute('DELETE FROM trigger_roles WHERE guild_id = ? AND trigger_word = ?', 
                        (guild_id, trigger_word))
        
        await conn.commit()
    
    async def get_trigger(self, guild_id, trigger_word):
        conn = await self._get_connection()
        cursor = await conn.execute('SELECT response FROM triggers WHERE guild_id = ? AND trigger_word = ?', 
                                (guild_id, trigger_word))
        data = await cursor.fetchone()
        return data[0] if data else None
    
    async def get_trigger_roles(self, guild_id, trigger_word):
        conn = await self._get_connection()
        cursor = await conn.execute('SELECT role_id FROM trigger_roles WHERE guild_id = ? AND trigger_word = ?', 
                                (guild_id, trigger_word))
        roles = await cursor.fetchall()
        return [role[0] for role in roles]
    
    async def get_all_triggers(self, guild_id):
        conn = await self._get_connection()
        cursor = await conn.execute('SELECT trigger_word FROM triggers WHERE guild_id = ?', 
                                (guild_id,))
        triggers = await cursor.fetchall()
        return [trigger[0] for trigger in triggers]
    
    async def trigger_exists(self, guild_id, trigger_word):
        conn = await self._get_connection()
        cursor = await conn.execute('SELECT 1 FROM triggers WHERE guild_id = ? AND trigger_word = ?', 
                                (guild_id, trigger_word))
        return await cursor.fetchone() is not None
    
    async def close(self):
        if self._connection_pool:
            await self._connection_pool.close()

# ุชููุฆุฉ ูุธุงู ูุงุนุฏุฉ ุงูุจูุงูุงุช
db_system = DatabaseSystem(DB_NAME)

# ูุธุงู ุงูุงุฎุชุตุงุฑุงุช ูุน ุชุญุณูู ุงูุฃุฏุงุก [citation:1]
class TriggerSystem:
    def __init__(self):
        self._triggers_cache = {}  # ูุงุด ููุงุฎุชุตุงุฑุงุช ูุชุญุณูู ุงูุฃุฏุงุก [citation:1]
        
    async def load_triggers(self, guild_id):
        """ุชุญููู ุงูุงุฎุชุตุงุฑุงุช ูููุงุด ูุชุญุณูู ุงูุฃุฏุงุก"""
        if guild_id not in self._triggers_cache:
            triggers = await db_system.get_all_triggers(guild_id)
            self._triggers_cache[guild_id] = triggers
        return self._triggers_cache[guild_id]
        
    async def invalidate_cache(self, guild_id):
        """ูุณุญ ุงููุงุด ุนูุฏ ุงูุชุนุฏูู ุนูู ุงูุงุฎุชุตุงุฑุงุช"""
        if guild_id in self._triggers_cache:
            del self._triggers_cache[guild_id]

# ุชููุฆุฉ ูุธุงู ุงูุงุฎุชุตุงุฑุงุช
trigger_system = TriggerSystem()

# ุฃุญุฏุงุซ ุงูุจูุช ูุน ุชุญุณูู ุงูุฃุฏุงุก [citation:1]
@bot.event
async def on_ready():
    print(f'โ ุชู ุชุณุฌูู ุงูุฏุฎูู ูู {bot.user}')
    await db_system.init_db()
    try:
        synced = await bot.tree.sync()
        print(f"โ ุชู ูุฒุงููุฉ {len(synced)} ุฃูุงูุฑ")
    except Exception as e:
        print(f"โ ุฎุทุฃ ูู ูุฒุงููุฉ ุงูุฃูุงูุฑ: {e}")

@bot.event
async def on_guild_join(guild):
    # ุฅุฑุณุงู ุฑุณุงูุฉ ุชุฑุญูุจ ุนูุฏ ุงูุถูุงู ุงูุจูุช ุฅูู ุณูุฑูุฑ ุฌุฏูุฏ
    for channel in guild.text_channels:
        if channel.permissions_for(guild.me).send_messages:
            try:
                # ุงูุญุตูู ุนูู ูุบุฉ ุงูุณูุฑูุฑ
                lang = await db_system.get_guild_language(guild.id)
                welcome_msg = translations[lang]["welcome_message"]
                await channel.send(welcome_msg)
            except:
                continue
            break

@bot.event
async def on_interaction(interaction):
    # ุงูุชุญูู ูู ุฃู ุงูุจูุช ูุณููุญ ูู ูู ูุฐู ุงูููุงุฉ
    if not await is_channel_allowed(interaction):
        lang = await db_system.get_guild_language(interaction.guild.id)
        await interaction.response.send_message(translations[lang]["channel_not_allowed"], ephemeral=True)
        return
    await bot.process_application_commands(interaction)

# ูุธุงู ุงูุงุฎุชุตุงุฑุงุช (Triggers)
@bot.event
async def on_message(message):
    # ุชุฌุงูู ุงูุฑุณุงุฆู ูู ุงูุจูุช ููุณู ูุชูููู ุงููุนุงูุฌุฉ [citation:1]
    if message.author == bot.user:
        return
    
    # ุชุฌุงูู ุงูุฑุณุงุฆู ูู ุงูุฑุณุงุฆู ุงูุฎุงุตุฉ (DM)
    if not message.guild:
        return
    
    # ุงูุชุญูู ูู ุฃู ุงูุจูุช ูุณููุญ ูู ูู ูุฐู ุงูููุงุฉ
    allowed_channels = await db_system.get_allowed_channels(message.guild.id)
    if allowed_channels and message.channel.id not in allowed_channels:
        return
    
    # ุงูุชุญูู ูู ูุฌูุฏ ุงุฎุชุตุงุฑ ูู ุงูุฑุณุงูุฉ ุจุงุณุชุฎุฏุงู ุงููุงุด [citation:1]
    try:
        triggers = await trigger_system.load_triggers(message.guild.id)
        for trigger in triggers:
            if trigger in message.content:
                # ุงูุญุตูู ุนูู ุฑุฏ ุงูุงุฎุชุตุงุฑ
                response = await db_system.get_trigger(message.guild.id, trigger)
                
                # ุงูุญุตูู ุนูู ุงูุฑุชุจ ุงููุณููุญุฉ ููุฐุง ุงูุงุฎุชุตุงุฑ
                allowed_roles = await db_system.get_trigger_roles(message.guild.id, trigger)
                
                # ุฅุฐุง ูู ูุชู ุชุญุฏูุฏ ุฑุชุจุ ูุฑุณู ุงูุฑุฏ ููุฌููุน
                if not allowed_roles:
                    await message.channel.send(response)
                    break
                
                # ุงูุชุญูู ุฅุฐุง ูุงู ูุฏู ุงููุณุชุฎุฏู ุฃู ูู ุงูุฑุชุจ ุงููุณููุญุฉ
                user_roles = [role.id for role in message.author.roles]
                has_allowed_role = any(role_id in user_roles for role_id in allowed_roles)
                
                if has_allowed_role:
                    await message.channel.send(response)
                    break
    except Exception as e:
        print(f"โ ุฎุทุฃ ูู ูุนุงูุฌุฉ ุงูุงุฎุชุตุงุฑุงุช: {e}")
    
    # ูุนุงูุฌุฉ ุงูุฃูุงูุฑ ุงูุนุงุฏูุฉ (ุงูุจุฑูููุณ)
    await bot.process_commands(message)

# ูุธููุฉ ููุชุญูู ูู ุตูุงุญูุฉ ุงูููุงุฉ
async def is_channel_allowed(interaction):
    allowed_channels = await db_system.get_allowed_channels(interaction.guild.id)
    # ุฅุฐุง ูู ูุชู ุชุญุฏูุฏ ูููุงุช ูุณููุญุฉุ ูููู ุงูุจูุช ูุนุงูุงู ูู ุฌููุน ุงููููุงุช
    if not allowed_channels:
        return True
    # ุฅุฐุง ุชู ุชุญุฏูุฏ ูููุงุช ูุณููุญุฉุ ุงูุชุญูู ูู ุฃู ุงูุฃูุฑ ูููุฐ ูู ููุงุฉ ูุณููุญุฉ
    return interaction.channel.id in allowed_channels

# ุงูุฃูุงูุฑ ุงูุฅุฏุงุฑูุฉ
@bot.tree.command(name="ban", description="ุญุธุฑ ุนุถู ูู ุงูุณูุฑูุฑ")
@app_commands.describe(member="ุงูุนุถู ุงููุฑุงุฏ ุญุธุฑู", reason="ุณุจุจ ุงูุญุธุฑ")
async def ban(interaction: discord.Interaction, member: discord.Member, reason: str = "ูุง ููุฌุฏ ุณุจุจ"):
    lang = await db_system.get_guild_language(interaction.guild.id)
    
    if not interaction.user.guild_permissions.ban_members:
        await interaction.response.send_message(translations[lang]["ban_no_permission"], ephemeral=True)
        return
    
    await member.ban(reason=reason)
    await interaction.response.send_message(translations[lang]["ban_success"].format(member.mention, reason))

@bot.tree.command(name="unban", description="ุฑูุน ุงูุญุธุฑ ุนู ุนุถู")
@app_commands.describe(user_id="ุงูุขูุฏู ุงูุฎุงุต ุจุงูุนุถู")
async def unban(interaction: discord.Interaction, user_id: str):
    lang = await db_system.get_guild_language(interaction.guild.id)
    
    if not interaction.user.guild_permissions.ban_members:
        await interaction.response.send_message(translations[lang]["unban_no_permission"], ephemeral=True)
        return
    
    try:
        user_id = int(user_id)
        user = await bot.fetch_user(user_id)
        await interaction.guild.unban(user)
        await interaction.response.send_message(translations[lang]["unban_success"].format(user.name))
    except (ValueError, discord.NotFound):
        await interaction.response.send_message(translations[lang]["unban_not_found"], ephemeral=True)

@bot.tree.command(name="kick", description="ุทุฑุฏ ุนุถู ูู ุงูุณูุฑูุฑ")
@app_commands.describe(member="ุงูุนุถู ุงููุฑุงุฏ ุทุฑุฏู", reason="ุณุจุจ ุงูุทุฑุฏ")
async def kick(interaction: discord.Interaction, member: discord.Member, reason: str = "ูุง ููุฌุฏ ุณุจุจ"):
    lang = await db_system.get_guild_language(interaction.guild.id)
    
    if not interaction.user.guild_permissions.kick_members:
        await interaction.response.send_message(translations[lang]["kick_no_permission"], ephemeral=True)
        return
    
    await member.kick(reason=reason)
    await interaction.response.send_message(translations[lang]["kick_success"].format(member.mention, reason))

@bot.tree.command(name="mute", description="ูุชู ุนุถู ูู ุงููููุงุช ุงูุตูุชูุฉ ุฃู ุงููุตูุฉ")
@app_commands.describe(member="ุงูุนุถู ุงููุฑุงุฏ ูุชูู", duration="ูุฏุฉ ุงููุชู (ุจุงูุฏูุงุฆู)", reason="ุณุจุจ ุงููุชู")
async def mute(interaction: discord.Interaction, member: discord.Member, duration: int = 10, reason: str = "ูุง ููุฌุฏ ุณุจุจ"):
    lang = await db_system.get_guild_language(interaction.guild.id)
    
    if not interaction.user.guild_permissions.mute_members:
        await interaction.response.send_message(translations[lang]["mute_no_permission"], ephemeral=True)
        return
    
    # ุฅูุดุงุก ุฑุชุจุฉ ูููุช ุฅุฐุง ูู ุชูู ููุฌูุฏุฉ
    mute_role = discord.utils.get(interaction.guild.roles, name="Muted")
    if not mute_role:
        mute_role = await interaction.guild.create_role(name="Muted")
        
        # ุฅุฒุงูุฉ ุตูุงุญูุงุช ุงูุชุญุฏุซ ูู ุฌููุน ุงููููุงุช
        for channel in interaction.guild.channels:
            await channel.set_permissions(mute_role, speak=False, send_messages=False)
    
    await member.add_roles(mute_role, reason=reason)
    await interaction.response.send_message(translations[lang]["mute_success"].format(member.mention, duration, reason))
    
    # ุฅุฒุงูุฉ ุงููุชู ุจุนุฏ ุงููุฏุฉ ุงููุญุฏุฏุฉ
    await asyncio.sleep(duration * 60)
    if mute_role in member.roles:
        await member.remove_roles(mute_role)

@bot.tree.command(name="unmute", description="ุฑูุน ุงููุชู ุนู ุนุถู")
@app_commands.describe(member="ุงูุนุถู ุงููุฑุงุฏ ุฑูุน ุงููุชู ุนูู")
async def unmute(interaction: discord.Interaction, member: discord.Member):
    lang = await db_system.get_guild_language(interaction.guild.id)
    
    if not interaction.user.guild_permissions.mute_members:
        await interaction.response.send_message(translations[lang]["unmute_no_permission"], ephemeral=True)
        return
    
    mute_role = discord.utils.get(interaction.guild.roles, name="Muted")
    if mute_role and mute_role in member.roles:
        await member.remove_roles(mute_role)
        await interaction.response.send_message(translations[lang]["unmute_success"].format(member.mention))
    else:
        await interaction.response.send_message(translations[lang]["unmute_not_muted"], ephemeral=True)

@bot.tree.command(name="warn", description="ุชุญุฐูุฑ ุนุถู")
@app_commands.describe(member="ุงูุนุถู ุงููุฑุงุฏ ุชุญุฐูุฑู", reason="ุณุจุจ ุงูุชุญุฐูุฑ")
async def warn(interaction: discord.Interaction, member: discord.Member, reason: str = "ูุง ููุฌุฏ ุณุจุจ"):
    lang = await db_system.get_guild_language(interaction.guild.id)
    
    if not interaction.user.guild_permissions.moderate_members:
        await interaction.response.send_message(translations[lang]["warn_no_permission"], ephemeral=True)
        return
    
    user_data = await db_system.get_user_data(member.id)
    new_warnings = user_data['warnings'] + 1
    
    async with aiosqlite.connect(DB_NAME) as db:
        await db.execute('UPDATE users SET warnings = ? WHERE user_id = ?', (new_warnings, member.id))
        await db.commit()
    
    await interaction.response.send_message(translations[lang]["warn_success"].format(member.mention, new_warnings, reason))

@bot.tree.command(name="clear", description="ูุณุญ ุงูุฑุณุงุฆู ูู ุงูููุงุฉ")
@app_commands.describe(amount="ุนุฏุฏ ุงูุฑุณุงุฆู ุงููุฑุงุฏ ูุณุญูุง")
async def clear(interaction: discord.Interaction, amount: int = 10):
    lang = await db_system.get_guild_language(interaction.guild.id)
    
    if not interaction.user.guild_permissions.manage_messages:
        await interaction.response.send_message(translations[lang]["clear_no_permission"], ephemeral=True)
        return
    
    if amount > 100:
        await interaction.response.send_message(translations[lang]["clear_too_many"], ephemeral=True)
        return
    
    await interaction.response.defer(ephemeral=True)
    deleted = await interaction.channel.purge(limit=amount)
    await interaction.followup.send(translations[lang]["clear_success"].format(len(deleted)), ephemeral=True)

@bot.tree.command(name="setnick", description="ุชุบููุฑ ููุจ ุนุถู")
@app_commands.describe(member="ุงูุนุถู ุงููุฑุงุฏ ุชุบููุฑ ููุจู", nickname="ุงูููุจ ุงูุฌุฏูุฏ")
async def setnick(interaction: discord.Interaction, member: discord.Member, nickname: str):
    lang = await db_system.get_guild_language(interaction.guild.id)
    
    if not interaction.user.guild_permissions.manage_nicknames:
        await interaction.response.send_message(translations[lang]["nick_no_permission"], ephemeral=True)
        return
    
    await member.edit(nick=nickname)
    await interaction.response.send_message(translations[lang]["nick_success"].format(member.mention, nickname))

@bot.tree.command(name="role", description="ุฅุถุงูุฉ ุฃู ุฅุฒุงูุฉ ุฏูุฑ ูู ุนุถู")
@app_commands.describe(member="ุงูุนุถู", role="ุงูุฏูุฑ", action="ุงูุฅุฌุฑุงุก (add/remove)")
async def role(interaction: discord.Interaction, member: discord.Member, role: discord.Role, action: str):
    lang = await db_system.get_guild_language(interaction.guild.id)
    
    if not interaction.user.guild_permissions.manage_roles:
        await interaction.response.send_message(translations[lang]["role_no_permission"], ephemeral=True)
        return
    
    if action.lower() == "add":
        await member.add_roles(role)
        await interaction.response.send_message(translations[lang]["role_add_success"].format(role.name, member.mention))
    elif action.lower() == "remove":
        await member.remove_roles(role)
        await interaction.response.send_message(translations[lang]["role_remove_success"].format(role.name, member.mention))
    else:
        await interaction.response.send_message(translations[lang]["role_invalid_action"], ephemeral=True)

@bot.tree.command(name="slowmode", description="ุชุนููู ูุถุน ุจุทูุก ููููุงุฉ")
@app_commands.describe(duration="ุงููุฏุฉ ุจุงูุซูุงูู (0 ูุฅูุบุงุก ุงููุถุน ุงูุจุทูุก)")
async def slowmode(interaction: discord.Interaction, duration: int = 10):
    lang = await db_system.get_guild_language(interaction.guild.id)
    
    if not interaction.user.guild_permissions.manage_channels:
        await interaction.response.send_message("ููุณ ูุฏูู ุตูุงุญูุฉ ูุฅุฏุงุฑุฉ ุงููููุงุช!", ephemeral=True)
        return
    
    if duration == 0:
        await interaction.channel.edit(slowmode_delay=0)
        await interaction.response.send_message(translations[lang]["slowmode_remove"])
    else:
        if duration > 21600:  # 6 ุณุงุนุงุช ุงูุญุฏ ุงูุฃูุตู
            duration = 21600
        await interaction.channel.edit(slowmode_delay=duration)
        await interaction.response.send_message(translations[lang]["slowmode_success"].format(duration))

@bot.tree.command(name="serverinfo", description="ุนุฑุถ ูุนูููุงุช ุงูุณูุฑูุฑ")
async def serverinfo(interaction: discord.Interaction):
    lang = await db_system.get_guild_language(interaction.guild.id)
    
    guild = interaction.guild
    title = translations[lang]["server_info_title"].format(guild.name)
    embed = discord.Embed(title=title, color=0x00ff00)
    embed.add_field(name="ุงููุงูู" if lang == "ar" else "Owner", value=guild.owner.mention, inline=True)
    embed.add_field(name="ุนุฏุฏ ุงูุฃุนุถุงุก" if lang == "ar" else "Members", value=guild.member_count, inline=True)
    embed.add_field(name="ุนุฏุฏ ุงููููุงุช" if lang == "ar" else "Channels", value=len(guild.channels), inline=True)
    embed.add_field(name="ุนุฏุฏ ุงูุฃุฏูุงุฑ" if lang == "ar" else "Roles", value=len(guild.roles), inline=True)
    embed.add_field(name="ุชุงุฑูุฎ ุงูุฅูุดุงุก" if lang == "ar" else "Created At", value=guild.created_at.strftime("%Y-%m-%d %H:%M:%S"), inline=True)
    embed.set_thumbnail(url=guild.icon.url if guild.icon else None)
    await interaction.response.send_message(embed=embed)

@bot.tree.command(name="userinfo", description="ุนุฑุถ ูุนูููุงุช ุงููุณุชุฎุฏู")
@app_commands.describe(member="ุงูุนุถู (ุงุฎุชูุงุฑู)")
async def userinfo(interaction: discord.Interaction, member: discord.Member = None):
    lang = await db_system.get_guild_language(interaction.guild.id)
    
    if not member:
        member = interaction.user
    
    user_data = await db_system.get_user_data(member.id)
    title = translations[lang]["user_info_title"].format(member)
    embed = discord.Embed(title=title, color=0x00ff00)
    embed.add_field(name="ุงุณู ุงููุณุชุฎุฏู" if lang == "ar" else "Username", value=member.name, inline=True)
    embed.add_field(name="ุงูุขูุฏู" if lang == "ar" else "ID", value=member.id, inline=True)
    embed.add_field(name="ุชุงุฑูุฎ ุงูุงูุถูุงู" if lang == "ar" else "Joined At", value=member.joined_at.strftime("%Y-%m-%d %H:%M:%S"), inline=True)
    embed.add_field(name="ุชุงุฑูุฎ ุฅูุดุงุก ุงูุญุณุงุจ" if lang == "ar" else "Created At", value=member.created_at.strftime("%Y-%m-%d %H:%M:%S"), inline=True)
    embed.add_field(name="ุงูููุงุท" if lang == "ar" else "Points", value=user_data['points'], inline=True)
    embed.add_field(name="ุงูุณูุนุฉ" if lang == "ar" else "Reputation", value=user_data['reputation'], inline=True)
    embed.add_field(name="ุงููุณุชูู" if lang == "ar" else "Level", value=user_data['level'], inline=True)
    embed.add_field(name="ุงูุชุญุฐูุฑุงุช" if lang == "ar" else "Warnings", value=user_data['warnings'], inline=True)
    embed.set_thumbnail(url=member.avatar.url if member.avatar else None)
    await interaction.response.send_message(embed=embed)

@bot.tree.command(name="credits", description="ุนุฑุถ ุฑุตูุฏ ุงูููุงุท")
@app_commands.describe(member="ุงูุนุถู (ุงุฎุชูุงุฑู)")
async def credits(interaction: discord.Interaction, member: discord.Member = None):
    lang = await db_system.get_guild_language(interaction.guild.id)
    
    if not member:
        member = interaction.user
    
    user_data = await db_system.get_user_data(member.id)
    await interaction.response.send_message(translations[lang]["points_display"].format(member.mention, user_data['points']))

@bot.tree.command(name="rep", description="ููุญ ููุทุฉ ุณูุนุฉ")
@app_commands.describe(member="ุงูุนุถู ุงููุฑุงุฏ ููุญู ุงูุณูุนุฉ")
async def rep(interaction: discord.Interaction, member: discord.Member):
    lang = await db_system.get_guild_language(interaction.guild.id)
    
    if member.id == interaction.user.id:
        await interaction.response.send_message(translations[lang]["rep_self"], ephemeral=True)
        return
    
    await db_system.add_reputation(member.id, 1)
    await interaction.response.send_message(translations[lang]["rep_success"].format(member.mention))

@bot.tree.command(name="rank", description="ุนุฑุถ ุฑุชุจุฉ ุงูุนุถู")
@app_commands.describe(member="ุงูุนุถู (ุงุฎุชูุงุฑู)")
async def rank(interaction: discord.Interaction, member: discord.Member = None):
    lang = await db_system.get_guild_language(interaction.guild.id)
    
    if not member:
        member = interaction.user
    
    user_data = await db_system.get_user_data(member.id)
    level = user_data['level']
    points = user_data['points']
    next_level_points = level * 100
    
    embed = discord.Embed(title=f"ุฑุชุจุฉ {member}" if lang == "ar" else f"{member}'s Rank", color=0x00ff00)
    embed.add_field(name="ุงููุณุชูู" if lang == "ar" else "Level", value=level, inline=True)
    embed.add_field(name="ุงูููุงุท" if lang == "ar" else "Points", value=f"{points}/{next_level_points}", inline=True)
    embed.add_field(name="ุงูุชูุฏู" if lang == "ar" else "Progress", value=f"{round((points/next_level_points)*100)}%", inline=True)
    await interaction.response.send_message(embed=embed)

@bot.tree.command(name="top", description="ุนุฑุถ ุฃูุถู ุงูุฃุนุถุงุก ุญุณุจ ุงููุดุงุท")
async def top(interaction: discord.Interaction):
    lang = await db_system.get_guild_language(interaction.guild.id)
    
    async with aiosqlite.connect(DB_NAME) as db:
        cursor = await db.execute('SELECT user_id, points FROM users ORDER BY points DESC LIMIT 10')
        top_users = await cursor.fetchall()
    
    title = translations[lang]["top_members_title"]
    embed = discord.Embed(title=title, color=0x00ff00)
    for i, (user_id, points) in enumerate(top_users, 1):
        user = bot.get_user(user_id)
        if user:
            embed.add_field(name=f"{i}. {user.name}", value=f"{points} {'ููุทุฉ' if lang == 'ar' else 'points'}", inline=False)
    
    await interaction.response.send_message(embed=embed)

@bot.tree.command(name="profile", description="ุนุฑุถ ุงูููู ุงูุดุฎุตู")
@app_commands.describe(member="ุงูุนุถู (ุงุฎุชูุงุฑู)")
async def profile(interaction: discord.Interaction, member: discord.Member = None):
    lang = await db_system.get_guild_language(interaction.guild.id)
    
    if not member:
        member = interaction.user
    
    user_data = await db_system.get_user_data(member.id)
    title = translations[lang]["profile_title"].format(member)
    embed = discord.Embed(title=title, color=0x00ff00)
    embed.add_field(name="ุงูููุงุท" if lang == "ar" else "Points", value=user_data['points'], inline=True)
    embed.add_field(name="ุงูุณูุนุฉ" if lang == "ar" else "Reputation", value=user_data['reputation'], inline=True)
    embed.add_field(name="ุงููุณุชูู" if lang == "ar" else "Level", value=user_data['level'], inline=True)
    embed.add_field(name="ุงูุชุญุฐูุฑุงุช" if lang == "ar" else "Warnings", value=user_data['warnings'], inline=True)
    embed.set_thumbnail(url=member.avatar.url if member.avatar else None)
    await interaction.response.send_message(embed=embed)

# ุงูุฃูุงูุฑ ุงูุชุฑููููุฉ
@bot.tree.command(name="roll", description="ุฑูู ูุฑุฏ ุนุดูุงุฆู")
@app_commands.describe(sides="ุนุฏุฏ ุฃูุฌู ุงููุฑุฏ (ุงุฎุชูุงุฑู)")
async def roll(interaction: discord.Interaction, sides: int = 6):
    lang = await db_system.get_guild_language(interaction.guild.id)
    
    if sides < 2:
        error_msg = "ูุฌุจ ุฃู ูููู ูููุฑุฏ ูุฌูุงู ุนูู ุงูุฃูู!" if lang == "ar" else "The dice must have at least two sides!"
        await interaction.response.send_message(error_msg, ephemeral=True)
        return
    
    result = random.randint(1, sides)
    await interaction.response.send_message(translations[lang]["roll_result"].format(interaction.user.mention, result, sides))

@bot.tree.command(name="8ball", description="ุณุคุงู ุงููุฑุฉ ุงูุณุญุฑูุฉ")
@app_commands.describe(question="ุงูุณุคุงู")
async def eight_ball(interaction: discord.Interaction, question: str):
    lang = await db_system.get_guild_language(interaction.guild.id)
    
    responses_ar = [
        "ูุนู ุจุงูุชุฃููุฏ",
        "ูู ุงููุญุชูู",
        "ุฃุธู ุฐูู",
        "ูุง ุฃุนุชูุฏ",
        "ุจุงูุทุจุน ูุง",
        "ุญุงูู ูุฑุฉ ุฃุฎุฑู",
        "ููุณ ุงูุขู",
        "ูุง ูููููู ุงูุฅุฌุงุจุฉ ุงูุขู",
        "ุงุณุฃู ูุฑุฉ ุฃุฎุฑู ูุงุญูุงู",
        "ุฑูุฒ ูุงุณุฃู ูุฑุฉ ุฃุฎุฑู"
    ]
    
    responses_en = [
        "Yes, definitely",
        "Most likely",
        "I think so",
        "I don't think so",
        "Of course not",
        "Try again",
        "Not now",
        "I can't answer now",
        "Ask again later",
        "Focus and ask again"
    ]
    
    response = random.choice(responses_ar if lang == "ar" else responses_en)
    await interaction.response.send_message(translations[lang]["8ball_response"].format(question, response))

@bot.tree.command(name="coinflip", description="ุฑูู ุนููุฉ ูุนุฏููุฉ")
async def coinflip(interaction: discord.Interaction):
    lang = await db_system.get_guild_language(interaction.guild.id)
    
    result = random.choice(["ุตูุฑุฉ", "ูุชุงุจุฉ"] if lang == "ar" else ["Heads", "Tails"])
    await interaction.response.send_message(translations[lang]["coinflip_result"].format(interaction.user.mention, result))

@bot.tree.command(name="meme", description="ุนุฑุถ ุตูุฑุฉ ููู ุนุดูุงุฆูุฉ")
async def meme(interaction: discord.Interaction):
    lang = await db_system.get_guild_language(interaction.guild.id)
    
    memes = [
        "https://i.imgur.com/8x9Zk9j.jpg",
        "https://i.imgur.com/3JQ2q0L.jpg",
        "https://i.imgur.com/5Z0Z0Z0.jpg",
        "https://i.imgur.com/7X8Y9Z0.jpg",
        "https://i.imgur.com/1A2B3C4.jpg"
    ]
    meme_url = random.choice(memes)
    title = translations[lang]["meme_title"]
    embed = discord.Embed(title=title, color=0x00ff00)
    embed.set_image(url=meme_url)
    await interaction.response.send_message(embed=embed)

@bot.tree.command(name="ping", description="ุงุฎุชุจุงุฑ ุณุฑุนุฉ ุงูุงุณุชุฌุงุจุฉ")
async def ping(interaction: discord.Interaction):
    lang = await db_system.get_guild_language(interaction.guild.id)
    
    latency = round(bot.latency * 1000)
    await interaction.response.send_message(translations[lang]["ping_result"].format(latency))

# ุฃูุฑ ุชุญุฏูุฏ ุงููุบุฉ
@bot.tree.command(name="language", description="ุชุญุฏูุฏ ูุบุฉ ุงูุจูุช")
@app_commands.describe(lang="ุงููุบุฉ (ar/en)")
async def language(interaction: discord.Interaction, lang: str):
    if lang not in ["ar", "en"]:
        await interaction.response.send_message("ุงูุฑุฌุงุก ุงุฎุชูุงุฑ ar ููุนุฑุจูุฉ ุฃู en ููุฅูุฌููุฒูุฉ / Please choose ar for Arabic or en for English", ephemeral=True)
        return
    
    current_lang = await db_system.get_guild_language(interaction.guild.id)
    
    if lang == current_lang:
        if lang == "ar":
            await interaction.response.send_message(translations[lang]["language_already_set"], ephemeral=True)
        else:
            await interaction.response.send_message(translations[lang]["language_already_set_english"], ephemeral=True)
    else:
        await db_system.set_guild_language(interaction.guild.id, lang)
        if lang == "ar":
            await interaction.response.send_message(translations[lang]["language_changed"])
        else:
            await interaction.response.send_message(translations[lang]["language_changed_english"])

# ุฃูุงูุฑ ุฅุฏุงุฑุฉ ุงููููุงุช ุงููุณููุญุฉ
@bot.tree.command(name="channel_restrict", description="ุชูููุฏ ุงูุจูุช ููููุงุฉ ุงูุญุงููุฉ")
async def channel_restrict(interaction: discord.Interaction):
    lang = await db_system.get_guild_language(interaction.guild.id)
    
    if not interaction.user.guild_permissions.administrator:
        await interaction.response.send_message("ููุณ ูุฏูู ุตูุงุญูุฉ ูุฅุฏุงุฑุฉ ุงููููุงุช!", ephemeral=True)
        return
    
    await db_system.add_allowed_channel(interaction.guild.id, interaction.channel.id)
    await interaction.response.send_message(translations[lang]["channel_restrict_success"].format(interaction.channel.mention))

@bot.tree.command(name="channel_unrestrict", description="ุฅูุบุงุก ุชูููุฏ ุงูุจูุช ููููุงุฉ ุงูุญุงููุฉ")
async def channel_unrestrict(interaction: discord.Interaction):
    lang = await db_system.get_guild_language(interaction.guild.id)
    
    if not interaction.user.guild_permissions.administrator:
        await interaction.response.send_message("ููุณ ูุฏูู ุตูุงุญูุฉ ูุฅุฏุงุฑุฉ ุงููููุงุช!", ephemeral=True)
    return

    await db_system.remove_allowed_channel(interaction.guild.id, interaction.channel.id)
    await interaction.response.send_message(translations[lang]["channel_restrict_remove"].format(interaction.channel.mention))

@bot.tree.command(name="channel_list", description="ุนุฑุถ ุงููููุงุช ุงููุณููุญ ููุจูุช ุจุงูุนูู ูููุง")
async def channel_list(interaction: discord.Interaction):
    lang = await db_system.get_guild_language(interaction.guild.id)
    
    allowed_channels = await db_system.get_allowed_channels(interaction.guild.id)
    if not allowed_channels:
        await interaction.response.send_message(translations[lang]["channel_restrict_none"])
    else:
        channels = [f"<#{channel_id}>" for channel_id in allowed_channels]
        await interaction.response.send_message(translations[lang]["channel_restrict_list"].format(", ".join(channels)))

# ุฃูุงูุฑ ุงูุฃูุณูุฉ
@bot.tree.command(name="tag_create", description="ุฅูุดุงุก ูุณู ุฌุฏูุฏ")
@app_commands.describe(name="ุงุณู ุงููุณู", content="ูุญุชูู ุงููุณู")
async def tag_create(interaction: discord.Interaction, name: str, content: str):
    lang = await db_system.get_guild_language(interaction.guild.id)
    
    existing_tag = await db_system.get_tag(interaction.guild.id, name)
    if existing_tag:
        await interaction.response.send_message(translations[lang]["tag_exists"], ephemeral=True)
        return
    
    await db_system.set_tag(interaction.guild.id, name, content)
    await interaction.response.send_message(translations[lang]["tag_created"].format(name))

@bot.tree.command(name="tag", description="ุนุฑุถ ูุญุชูู ุงููุณู")
@app_commands.describe(name="ุงุณู ุงููุณู")
async def tag(interaction: discord.Interaction, name: str):
    lang = await db_system.get_guild_language(interaction.guild.id)
    
    tag_content = await db_system.get_tag(interaction.guild.id, name)
    if not tag_content:
        await interaction.response.send_message(translations[lang]["tag_not_found"].format(name), ephemeral=True)
        return
    
    await interaction.response.send_message(tag_content)

@bot.tree.command(name="tag_delete", description="ุญุฐู ูุณู")
@app_commands.describe(name="ุงุณู ุงููุณู")
async def tag_delete(interaction: discord.Interaction, name: str):
    lang = await db_system.get_guild_language(interaction.guild.id)
    
    if not interaction.user.guild_permissions.manage_messages:
        await interaction.response.send_message("ููุณ ูุฏูู ุตูุงุญูุฉ ูุฅุฏุงุฑุฉ ุงููุณูู!", ephemeral=True)
        return
    
    tag_content = await db_system.get_tag(interaction.guild.id, name)
    if not tag_content:
        await interaction.response.send_message(translations[lang]["tag_not_found"].format(name), ephemeral=True)
        return
    
    await db_system.delete_tag(interaction.guild.id, name)
    await interaction.response.send_message(translations[lang]["tag_deleted"].format(name))

@bot.tree.command(name="tag_list", description="ุนุฑุถ ูุงุฆูุฉ ุฌููุน ุงูุฃูุณูุฉ")
async def tag_list(interaction: discord.Interaction):
    lang = await db_system.get_guild_language(interaction.guild.id)
    
    tags = await db_system.get_all_tags(interaction.guild.id)
    if not tags:
        await interaction.response.send_message("ูุง ุชูุฌุฏ ุฃูุณูุฉ ูู ูุฐุง ุงูุณูุฑูุฑ!", ephemeral=True)
        return
    
    embed = discord.Embed(title="ูุงุฆูุฉ ุงูุฃูุณูุฉ", color=0x00ff00)
    embed.description = "\n".join([f"โข {tag}" for tag in tags])
    await interaction.response.send_message(embed=embed)

# ุฃูุงูุฑ ุฅุถุงููุฉ
@bot.tree.command(name="poll", description="ุฅูุดุงุก ุงุณุชูุชุงุก")
@app_commands.describe(question="ุณุคุงู ุงูุงุณุชูุชุงุก", option1="ุงูุฎูุงุฑ ุงูุฃูู", option2="ุงูุฎูุงุฑ ุงูุซุงูู")
async def poll(interaction: discord.Interaction, question: str, option1: str, option2: str):
    lang = await db_system.get_guild_language(interaction.guild.id)
    
    embed = discord.Embed(title=translations[lang]["poll_question"], description=question, color=0x00ff00)
    embed.add_field(name="ุงูุฎูุงุฑ 1", value=option1, inline=True)
    embed.add_field(name="ุงูุฎูุงุฑ 2", value=option2, inline=True)
    
    message = await interaction.response.send_message(embed=embed)
    await message.add_reaction("1๏ธโฃ")
    await message.add_reaction("2๏ธโฃ")

@bot.tree.command(name="invite", description="ุงูุญุตูู ุนูู ุฑุงุจุท ุฏุนูุฉ ุงูุจูุช")
async def invite(interaction: discord.Interaction):
    lang = await db_system.get_guild_language(interaction.guild.id)
    
    invite_url = translations[lang]["invite_bot"].format(bot.user.id)
    await interaction.response.send_message(f"ุฑุงุจุท ุฏุนูุฉ ุงูุจูุช: {invite_url}")

@bot.tree.command(name="help", description="ุนุฑุถ ุฌููุน ุฃูุงูุฑ ุงูุจูุช")
async def help_command(interaction: discord.Interaction):
    lang = await db_system.get_guild_language(interaction.guild.id)
    
    await interaction.response.send_message(translations[lang]["help_command"])

# ุฃูุงูุฑ ุฅุฏุงุฑุฉ ุงูุงุฎุชุตุงุฑุงุช (ุจุงุณุชุฎุฏุงู ุงูุจุฑูููุณ)
@bot.command(name='addtrigger')
async def add_trigger(ctx, trigger_word, *args):
    lang = await db_system.get_guild_language(ctx.guild.id)
    
    if not ctx.author.guild_permissions.administrator:
        await ctx.send(translations[lang]["trigger_no_permission"])
        return
    
    # ูุตู ุงูุฑุฏ ูุงูุฑุชุจ ูู ุงููุณุงุฆุท
    response_parts = []
    role_ids = []
    
    for arg in args:
        if arg.startswith('<@&') and arg.endswith('>'):  # ุชุญุฏูุฏ ุฅุฐุง ูุงู ุงููุณูุท ูู ุฑุชุจุฉ
            role_id = int(arg[3:-1])
            role_ids.append(role_id)
        else:
            response_parts.append(arg)
    
    response = ' '.join(response_parts)
    
    # ุงูุชุญูู ุฅุฐุง ูุงู ุงูุงุฎุชุตุงุฑ ููุฌูุฏุงู ุจุงููุนู
    if await db_system.trigger_exists(ctx.guild.id, trigger_word):
        await ctx.send(translations[lang]["trigger_exists"].format(trigger_word))
        return
    
    # ุฅุถุงูุฉ ุงูุงุฎุชุตุงุฑ
    await db_system.add_trigger(ctx.guild.id, trigger_word, response, role_ids)
    await trigger_system.invalidate_cache(ctx.guild.id)
    
    # ุงูุญุตูู ุนูู ุฃุณูุงุก ุงูุฑุชุจ ูุนุฑุถูุง
    role_mentions = []
    for role_id in role_ids:
        role = ctx.guild.get_role(role_id)
        if role:
            role_mentions.append(role.mention)
    
    role_list = ", ".join(role_mentions) if role_mentions else "ุงูุฌููุน"
    
    await ctx.send(translations[lang]["trigger_added"].format(trigger_word, role_list))

@bot.command(name='deltrigger')
async def del_trigger(ctx, trigger_word):
    lang = await db_system.get_guild_language(ctx.guild.id)
    
    if not ctx.author.guild_permissions.administrator:
        await ctx.send(translations[lang]["trigger_no_permission"])
        return
    
    # ุงูุชุญูู ุฅุฐุง ูุงู ุงูุงุฎุชุตุงุฑ ููุฌูุฏุงู
    if not await db_system.trigger_exists(ctx.guild.id, trigger_word):
        await ctx.send(translations[lang]["trigger_not_found"].format(trigger_word))
        return
    
    # ุญุฐู ุงูุงุฎุชุตุงุฑ
    await db_system.remove_trigger(ctx.guild.id, trigger_word)
    await trigger_system.invalidate_cache(ctx.guild.id)
    await ctx.send(translations[lang]["trigger_removed"].format(trigger_word))

@bot.command(name='listtriggers')
async def list_triggers(ctx):
    lang = await db_system.get_guild_language(ctx.guild.id)
    
    if not ctx.author.guild_permissions.administrator:
        await ctx.send(translations[lang]["trigger_no_permission"])
        return
    
    # ุงูุญุตูู ุนูู ุฌููุน ุงูุงุฎุชุตุงุฑุงุช
    triggers = await db_system.get_all_triggers(ctx.guild.id)
    
    if not triggers:
        await ctx.send("ูุง ุชูุฌุฏ ุงุฎุชุตุงุฑุงุช ูู ูุฐุง ุงูุณูุฑูุฑ!")
        return
    
    # ุงูุญุตูู ุนูู ูุนูููุงุช ูู ุงุฎุชุตุงุฑ
    trigger_list = []
    for trigger in triggers:
        response = await db_system.get_trigger(ctx.guild.id, trigger)
        allowed_roles = await db_system.get_trigger_roles(ctx.guild.id, trigger)
        
        role_mentions = []
        for role_id in allowed_roles:
            role = ctx.guild.get_role(role_id)
            if role:
                role_mentions.append(role.name)
        
        role_list = ", ".join(role_mentions) if role_mentions else "ุงูุฌููุน"
        trigger_list.append(f"**{trigger}** โ {response} (ูุณููุญ ููุฑุชุจ: {role_list})")
    
    await ctx.send(translations[lang]["trigger_list"].format("\n".join(trigger_list)))

# ุชุดุบูู ุงูุจูุช ูุน ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก [citation:1]
async def main():
    try:
        token = os.getenv("DISCORD_BOT_TOKEN")
        if not token:
            raise ValueError("ูู ูุชู ุชุนููู ุฑูุฒ ุงูุจูุช ูู ูุชุบูุฑุงุช ุงูุจูุฆุฉ!")
        await bot.start(token)
    except Exception as e:
        print(f"โ ุฎุทุฃ ูู ุชุดุบูู ุงูุจูุช: {e}")
    finally:
        await db_system.close()

if __name__ == "__main__":
    asyncio.run(main())
